@using QLBanHang_UI.Models;
@model IEnumerable<CategoryDetailDto>
<!DOCTYPE html>
<html lang="en">

<head>
	@await Html.PartialAsync("_Header")
	<script src="~/js/jquery.min.js"></script>
</head>

<body>

	<!-- START Wrapper -->
	<div class="wrapper">

		<!-- ========== Topbar Start ========== -->
		<header class="topbar">
			<div class="container-fluid">
				<div class="navbar-header">
					<div class="d-flex align-items-center">
						<!-- Menu Toggle Button -->
						<div class="topbar-item">
							<button type="button" class="button-toggle-menu me-2">
								<iconify-icon icon="solar:hamburger-menu-broken" class="fs-24 align-middle"></iconify-icon>
							</button>
						</div>

						<!-- Menu Toggle Button -->
						<div class="topbar-item">
							<h4 class="fw-bold topbar-button pe-none text-uppercase mb-0">Danh Sách Danh Mục</h4>
						</div>
					</div>

					<div class="d-flex align-items-center gap-1">

						@await Html.PartialAsync("_Topbar")

						<!-- App Search-->
						<form class="app-search d-none d-md-block ms-2">
							<div class="position-relative">
								<input type="search" name="searchQuery" class="form-control" placeholder="Tìm kiếm..." autocomplete="off" value="">
								<iconify-icon icon="solar:magnifer-linear" class="search-widget-icon"></iconify-icon>
							</div>
						</form>
					</div>
				</div>
			</div>
		</header>

		<!-- Right Sidebar (Theme Settings) -->
		@await Html.PartialAsync("_SidebarRight")
		<!-- ========== Topbar End ========== -->
		<!-- ========== App Menu Start ========== -->
		@await Html.PartialAsync("_SidebarMenu")
		<!-- ========== App Menu End ========== -->
		<!-- ==================================================== -->
		<!-- Start right Content here -->
		<!-- ==================================================== -->
		<div class="page-content">

			<!-- Start Container Fluid -->
			<div class="container-xxl">

				<div class="row">
					<div class="col-md-6 col-xl-3">
						<div class="card">
							<div class="card-body text-center">
								<div class="rounded bg-secondary-subtle d-flex align-items-center justify-content-center mx-auto">
									<img src="~/images/product/p-1.png" alt="" class="avatar-xl">
								</div>
								<h4 class="mt-3 mb-0">Đặc Sản Đà Nẵng</h4>
							</div>
						</div>
					</div>
					<div class="col-md-6 col-xl-3">
						<div class="card">
							<div class="card-body text-center">
								<div class="rounded bg-primary-subtle d-flex align-items-center justify-content-center mx-auto">
									<img src="~/images/product/p-6.png" alt="" class="avatar-xl">
								</div>
								<h4 class="mt-3 mb-0">Đặc Sản Hội An</h4>
							</div>
						</div>
					</div>

					<div class="col-md-6 col-xl-3">
						<div class="card">
							<div class="card-body text-center">
								<div class="rounded bg-warning-subtle d-flex align-items-center justify-content-center mx-auto">
									<img src="~/images/product/p-7.png" alt="" class="avatar-xl">
								</div>
								<h4 class="mt-3 mb-0">Thời Trang & Phụ Kiện</h4>
							</div>
						</div>
					</div>

					<div class="col-md-6 col-xl-3">
						<div class="card">
							<div class="card-body text-center">
								<div class="rounded bg-info-subtle d-flex align-items-center justify-content-center mx-auto">
									<img src="~/images/product/p-9.png" alt="" class="avatar-xl">
								</div>
								<h4 class="mt-3 mb-0">Thủ Công Mỹ Nghệ</h4>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-xl-12">
						<div class="card">
							<div class="card-header d-flex justify-content-between align-items-center gap-1">
								<h4 class="card-title flex-grow-1">Tất Cả</h4>

								<a href="@Url.Action("CreateCategory", "Category")" class="btn btn-sm btn-primary px-4">
									Thêm Mới
								</a>

								<div class="dropdown">
									<a href="#" class="dropdown-toggle btn btn-sm btn-outline-light" data-bs-toggle="dropdown" aria-expanded="false">
										Sắp Xếp
									</a>
									<div class="dropdown-menu dropdown-menu-end">
										<!-- item-->
										<a href="#!" class="dropdown-item" onclick="setSortCriteria('name')">Tên</a>
										<!-- item-->
										<a href="#!" class="dropdown-item" onclick="setSortCriteria('productCount')">Số Lượng SP</a>
									</div>
								</div>
							</div>
							<div>
								<div class="table-responsive">
									<table id="categoryTable" class="table align-middle mb-0 table-hover table-centered">
										<thead class="bg-light-subtle">
											<tr>
												<th style="width: 20px;">#</th>
												<th>Danh Mục</th>
												<th>Khoảng Giá</th>
												<th>Tạo Bới</th>
												<th>Tồn Kho</th>
												<th>Hành Động</th>
											</tr>
										</thead>
										<tbody id="categoryTableBody">
											<!--Data-->
										</tbody>
									</table>
								</div>
								<!-- end table-responsive -->
							</div>


							<div class="card-footer border-top">
								<nav aria-label="Page navigation example">
									<ul class="pagination justify-content-end mb-0" id="pagination">
										<!--Trang-->
									</ul>
								</nav>
							</div>
						</div>
					</div>
				</div>

			</div>
			<!-- End Container Fluid -->
			<!-- ========== Footer Start ========== -->
			@await Html.PartialAsync("_Footer")
			<!-- ========== Footer End ========== -->

		</div>
		<!-- ==================================================== -->
		<!-- End Page Content -->
		<!-- ==================================================== -->


	</div>
	<!-- END Wrapper -->
	<!-- Vendor Javascript (Require in all Page) -->
	<script src="~/js/vendor.js"></script>

	<!-- App Javascript (Require in all Page) -->
	<script src="~/js/app.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		const itemsPerPage = 8;
		let currentPage = 1;
		const maxVisiblePages = 5;
		let searchQuery = '';
		let sortCriteria = 'name';

		function updateUrlParameters() {
			const url = new URL(window.location);
			url.searchParams.set('searchQuery', searchQuery);
			url.searchParams.set('sortCriteria', sortCriteria);
			url.searchParams.set('currentPage', currentPage);
			window.history.pushState({}, '', url);
			console.log('Updated URL:', url.toString());
		}

		function setSortCriteria(criteria) {
			sortCriteria = criteria;
			currentPage = 1;
			updateUrlParameters();
			renderCategoryTable(currentPage);
			renderPagination();
		}

		async function renderCategoryTable(page) {
			const paginatedCategories = await GetCategory(searchQuery, page, itemsPerPage, sortCriteria);
			const tableBody = document.getElementById('categoryTableBody');
			tableBody.innerHTML = '';
			paginatedCategories.forEach((item, index) => {
				tableBody.innerHTML += HTMLCategory(item, (page - 1) * itemsPerPage + index);
			});
		}

		async function deleteCategory(categoryId) {
			const confirmDelete = confirm('Are you sure you want to delete this category?');
			if (!confirmDelete) return;

			try {
				const url = `https://localhost:7069/api/Category/DeleteCategory/${encodeURIComponent(categoryId)}`;
				await $.ajax({
					url: url,
					type: 'DELETE',
					success: function (result) {
						alert('Category deleted successfully!');
						renderCategoryTable(currentPage);
						renderPagination();
					},
					error: function (jqXHR, textStatus, errorThrown) {
						console.error('Error: ', textStatus, errorThrown);
						alert('Failed to delete the category.');
					}
				});
			} catch (error) {
				console.error('Error: ', error);
				alert('Failed to delete the category');
			}
		}

		async function renderPagination() {
			const totalPages = await GetTotalPages();
			const pagination = document.getElementById('pagination');
			pagination.innerHTML = '';

			let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
			let endPage = Math.min(totalPages, currentPage + Math.floor(maxVisiblePages / 2));

			if (endPage - startPage + 1 < maxVisiblePages) {
				if (endPage === totalPages) {
					startPage = Math.max(1, endPage - maxVisiblePages + 1);
				} else {
					endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
				}
			}

			pagination.innerHTML += `
							<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
								<a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage - 1})">Trước</a>
							</li>
						`;

			for (let i = startPage; i <= endPage; i++) {
				pagination.innerHTML += `
								<li class="page-item ${i === currentPage ? 'active' : ''}">
									<a class="page-link" href="javascript:void(0);" onclick="changePage(${i})">${i}</a>
								</li>
							`;
			}

			pagination.innerHTML += `
							<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
								<a class="page-link" href="javascript:void(0);" onclick="changePage(${currentPage + 1})">Tiếp Theo</a>
							</li>
						`;
		}

		async function changePage(page) {
			const totalPages = await GetTotalPages();
			if (page < 1 || page > totalPages) return;
			currentPage = page;
			await renderCategoryTable(page);
			renderPagination();
		}

		function HTMLCategory(item, index) {
			const minPrice = parseFloat(item.minPrice);
			const maxPrice = parseFloat(item.maxPrice);
			const formattedMinPrice = isNaN(minPrice) ? '0' : minPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
			const formattedMaxPrice = isNaN(maxPrice) ? '0' : maxPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
			return `
							<tr>
								<td>${index + 1}</td>
								<td>${item.categoryName}</td>
								<td>${formattedMinPrice} - ${formattedMaxPrice}</td>
								<td>Admin</td>
								<td>${item.productStock}</td>
								<td>
									   <div class="d-flex gap-2">
										   <a href="UpdateCategory/${item.categoryId}" class="btn btn-light btn-sm"><iconify-icon icon="solar:eye-broken" class="align-middle fs-18"></iconify-icon></a>
										   <a href="UpdateCategory/${item.categoryId}" class="btn btn-soft-primary btn-sm"><iconify-icon icon="solar:pen-2-broken" class="align-middle fs-18"></iconify-icon></a>
										   <a href="javascript:void(0);" onclick="confirmDelete('${item.categoryId}')" class="btn btn-soft-danger btn-sm"><iconify-icon icon="solar:trash-bin-minimalistic-2-broken" class="align-middle fs-18"></iconify-icon></a>

									   </div>
								 </td>
							</tr>
						`;
		}

		async function GetCategory(textsearch, page, limit, sortCriteria) {
			const url = `https://localhost:7069/api/Category/GetFilteredCategories?searchQuery=${encodeURIComponent(textsearch)}&page=${page}&sortCriteria=${encodeURIComponent(sortCriteria)}&isDescending=false`;
			return new Promise((resolve, reject) => {
				$.ajax({
					url: url,
					type: 'GET',
					dataType: 'json',
					success: function (data) {
						resolve(data);
						console.log('Data received:', data);
					},
					error: function (jqXHR, textStatus, errorThrown) {
						console.error('Error:', textStatus, errorThrown);
						reject(errorThrown);
					}
				});
			});
		}

		async function GetTotalPages() {
			const response = await $.ajax({
				url: 'https://localhost:7069/api/Category/TotalPagesCategory?searchQuery=' + encodeURIComponent(searchQuery),
				type: 'GET',
				dataType: 'json'
			});
			return response > 0 ? response : 1;
		}

		document.querySelector('input[name="searchQuery"]').addEventListener('keydown', async (event) => {
			if (event.key === 'Enter') {
				event.preventDefault();
				searchQuery = event.target.value;
				currentPage = 1;
				await renderCategoryTable(currentPage);
				await renderPagination();
			}
		});

		function confirmDelete(categoryId) {
			const userConfirmed = confirm("Bạn có chắc chắn muốn xóa danh mục này?");
			if (userConfirmed) {
				// Gửi yêu cầu xóa tới API
				deleteCategory(categoryId);
			}
		}

		async function deleteCategory(categoryId) {
			try {
				const response = await fetch(`https://localhost:7069/api/Category/${categoryId}`, {
					method: 'DELETE',
				});

				if (response.ok) {
					// Nếu xóa thành công, cập nhật lại giao diện (có thể xóa dòng khỏi bảng)
					alert('Danh mục đã được xóa!');
					window.location.reload(); // Tải lại trang hoặc xóa dòng khỏi bảng
				} else {
					// Xử lý nếu có lỗi
					alert('Không thể xóa danh mục!');
				}
			} catch (error) {
				console.error('Có lỗi khi xóa danh mục:', error);
				alert('Lỗi khi xóa danh mục!');
			}
		}
		renderCategoryTable(currentPage);
		renderPagination();
	</script>
</body>

</html>